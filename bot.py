from openai import OpenAI
import requests
import json
from datetime import datetime
import random
import os
import threading
import time
import re
from dotenv import load_dotenv

load_dotenv()

LAUNCH_TIMESTAMP = int(time.time())

WHATSAPP_TOKEN = "dT0r8H22LG6eFrF2A2dgKBaqAU5QcHIR"
WHATSAPP_PHONE_ID = os.getenv("WHATSAPP_PHONE_ID", "").strip()
API_KEY = os.getenv("PERPLEXITY_API_KEY")
KASPI_NUMBER = "+77076440186"
KASPI_NAME = "–û—Ç–∞–±–µ–∫ –ú"

# –ü—É—Ç—å –∫ —Ñ–æ—Ç–æ –º–µ–Ω—é
MENU_IMAGE_PATH = "menu.jpg"
MENU_KEYWORDS = [
    "–º”ô–∑—ñ—Ä",
    "–º–µ–Ω—é",
    "–Ω–µ –±–∞—Ä",
    "–∫”©—Ä—Å–µ—Ç",
    "–±—ñ–ª–º–µ–π–º—ñ–Ω",
    "–Ω–µ –∑–Ω–∞—é",
    "—á—Ç–æ –∑–∞–∫–∞–∑–∞—Ç—å",
    "–Ω–µ –∑–Ω–∞—é —á—Ç–æ",
    "–Ω–µ –∑–Ω–∞—é —á—Ç–æ –∑–∞–∫–∞–∑–∞—Ç—å",
    "—á—Ç–æ –ø–æ—Å–æ–≤–µ—Ç—É–µ—à—å",
    "–Ω–µ –∑–Ω–∞—é —á—Ç–æ –≤—ã–±—Ä–∞—Ç—å",
    "–ø–æ–¥—Å–∫–∞–∂–∏ –º–µ–Ω—é",
    "–Ω–µ –∑–∞–∫–∞–∑–∞–ª",
    "–Ω–µ –∑–Ω–∞—é –∑–∞–∫–∞–∑"
]

# ======================== –ú–ï–ù–Æ –†–ï–°–¢–û–†–ê–ù–ê ========================
MENU = {
    "–±—É—Ä–≥–µ—Ä–ª–µ—Ä": [
        {"name": "–ö–ª–∞—Å—Å–∏–∫–∞–ª—ã“õ –ë—É—Ä–≥–µ—Ä", "price": 1500, "desc": "–°–æ—á–Ω—ã–π —Å–∏—ã—Ä –µ—Ç—ñ, —Å–∞–ª–∞—Ç, “õ—ã–∑–∞–Ω–∞“õ, “õ–∏—è—Ä, —Ñ–∏—Ä–º–∞–ª—ã“õ —Å–æ—É—Å"},
        {"name": "“ö–æ—Å –ë—É—Ä–≥–µ—Ä", "price": 2200, "desc": "–ï–∫—ñ –∫–æ—Ç–ª–µ—Ç, “õ–æ—Å —ñ—Ä—ñ–º—à—ñ–∫, –±–µ–∫–æ–Ω, –ø–∏—è–∑"},
        {"name": "–¢–∞—É—ã“õ –ë—É—Ä–≥–µ—Ä", "price": 1400, "desc": "“ö—ã—Ç—ã—Ä–ª–∞“õ —Ç–∞—É—ã“õ –∫–æ—Ç–ª–µ—Ç—ñ, BBQ —Å–æ—É—Å"},
        {"name": "–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω–¥—ã“õ", "price": 1200, "desc": "–ù“±—Ç –∫–æ—Ç–ª–µ—Ç—ñ, –∞–≤–æ–∫–∞–¥–æ, –∂–∞“£–∞ –∫”©–∫”©–Ω—ñ—Å—Ç–µ—Ä"}
    ],
    "–ø–∏—Ü—Ü–∞": [
        {"name": "–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ (30—Å–º)", "price": 2000, "desc": "–ú–æ—Ü–∞—Ä–µ–ª–ª–∞, “õ—ã–∑–∞–Ω–∞“õ, –±–∞–∑–∏–ª–∏–∫"},
        {"name": "–ü–µ–ø–ø–µ—Ä–æ–Ω–∏ (30—Å–º)", "price": 2500, "desc": "”®—Ç–∫—ñ—Ä —à“±–∂—ã“õ, –º–æ—Ü–∞—Ä–µ–ª–ª–∞"},
        {"name": "4 –Ü—Ä—ñ–º—à—ñ–∫ (30—Å–º)", "price": 2700, "desc": "–ú–æ—Ü–∞—Ä–µ–ª–ª–∞, –ø–∞—Ä–º–µ–∑–∞–Ω, –¥–æ—Ä –±–ª—é, —á–µ–¥–¥–µ—Ä"},
        {"name": "–ï—Ç—Ç—ñ (35—Å–º)", "price": 3200, "desc": "–ë–µ–∫–æ–Ω, –≤–µ—Ç—á–∏–Ω–∞, —Ç–∞—É—ã“õ, —Å–∏—ã—Ä –µ—Ç—ñ"}
    ],
    "–≥–∞—Ä–Ω–∏—Ä–ª–µ—Ä": [
        {"name": "–ö–∞—Ä—Ç–æ–ø –§—Ä–∏ –∫—ñ—à—ñ", "price": 500, "desc": "150–≥ “õ—ã—Ç—ã—Ä–ª–∞“õ –∫–∞—Ä—Ç–æ–ø"},
        {"name": "–ö–∞—Ä—Ç–æ–ø –§—Ä–∏ “Ø–ª–∫–µ–Ω", "price": 800, "desc": "300–≥ “õ—ã—Ç—ã—Ä–ª–∞“õ –∫–∞—Ä—Ç–æ–ø"},
        {"name": "–ù–∞–≥–≥–µ—Ç—Å 6–¥–∞–Ω–∞", "price": 900, "desc": "–¢–∞—É—ã“õ –Ω–∞–≥–≥–µ—Ç—Å—Ç–µ—Ä—ñ —Å–æ—É—Å–ø–µ–Ω"},
        {"name": "–ü–∏—è–∑ —Å–∞“õ–∏–Ω–∞–ª–∞—Ä—ã", "price": 650, "desc": "“ö—ã—Ç—ã—Ä–ª–∞“õ –ø–∞–Ω–∏—Ä–æ–≤–∫–∞–¥–∞"},
        {"name": "–Ü—Ä—ñ–º—à—ñ–∫ —Ç–∞—è“õ—à–∞–ª–∞—Ä", "price": 950, "desc": "–ú–æ—Ü–∞—Ä–µ–ª–ª–∞ –ø–∞–Ω–∏—Ä–æ–≤–∫–∞–¥–∞, 8–¥–∞–Ω–∞"}
    ],
    "—Å–∞–ª–∞—Ç—Ç–∞—Ä": [
        {"name": "–¶–µ–∑–∞—Ä—å —Ç–∞—É—ã“õ–ø–µ–Ω", "price": 1400, "desc": "–¢–∞—É—ã“õ, —Å–∞–ª–∞—Ç, –ø–∞—Ä–º–µ–∑–∞–Ω, –¶–µ–∑–∞—Ä—å —Å–æ—É—Å"},
        {"name": "–ì—Ä–µ–∫ —Å–∞–ª–∞—Ç—ã", "price": 1200, "desc": "–ñ–∞“£–∞ –∫”©–∫”©–Ω—ñ—Å—Ç–µ—Ä, —Ñ–µ—Ç–∞, –∑”ô–π—Ç“Ø–Ω"},
        {"name": "–ö”©–∫”©–Ω—ñ—Å –º–∏–∫—Å", "price": 900, "desc": "–ñ–∞“£–∞ –º–∞—É—Å—ã–º–¥—ã“õ –∫”©–∫”©–Ω—ñ—Å—Ç–µ—Ä"}
    ],
    "—Å—É—Å—ã–Ω–¥–∞—Ä": [
        {"name": "–ö–æ–ª–∞ 0.5–ª", "price": 450, "desc": "Coca-Cola"},
        {"name": "–®—ã—Ä—ã–Ω 0.3–ª", "price": 350, "desc": "–ê–ø–µ–ª—å—Å–∏–Ω/–ê–ª–º–∞"},
        {"name": "–°—É 0.5–ª", "price": 200, "desc": "–ì–∞–∑—Å—ã–∑"},
        {"name": "–°“Ø—Ç—Ç—ñ –∫–æ–∫—Ç–µ–π–ª—å", "price": 800, "desc": "–í–∞–Ω–∏–ª—å/–®–æ–∫–æ–ª–∞–¥/“ö“±–ª–ø—ã–Ω–∞–π"},
        {"name": "“Æ–π–¥–µ–≥—ñ–¥–µ–π –ª–∏–º–æ–Ω–∞–¥", "price": 500, "desc": "0.4–ª"}
    ],
    "–¥–µ—Å–µ—Ä—Ç—Ç–µ—Ä": [
        {"name": "–ß–∏–∑–∫–µ–π–∫ NY", "price": 950, "desc": "–ö–ª–∞—Å—Å–∏–∫–∞–ª—ã“õ –ù—å—é-–ô–æ—Ä–∫"},
        {"name": "–ë–∞–ª–º“±–∑–¥–∞“õ", "price": 450, "desc": "3 —à–∞—Ä —Ç–∞“£–¥–∞—É—ã“£—ã–∑—à–∞"},
        {"name": "–ü–æ–Ω—á–∏–∫—Ç–µ—Ä 3–¥–∞–Ω–∞", "price": 650, "desc": "–ì–ª–∞–∑—É—Ä—å–º–µ–Ω"},
        {"name": "–ê–ª–º–∞ –ø–∏—Ä–æ–≥—ã", "price": 550, "desc": "–ñ—ã–ª—ã, –¥–∞—Ä—á—ã–Ω–º–µ–Ω"}
    ]
}

COMBOS = [
    {"name": "–ö–û–ú–ë–û #1 –ö–ª–∞—Å—Å–∏–∫–∞", "items": ["–ö–ª–∞—Å—Å–∏–∫–∞–ª—ã“õ –ë—É—Ä–≥–µ—Ä", "–ö–∞—Ä—Ç–æ–ø –§—Ä–∏ –∫—ñ—à—ñ", "–ö–æ–ª–∞ 0.5–ª"], "price": 2000, "saving": 450},
    {"name": "–ö–û–ú–ë–û #2 “ö–æ—Å", "items": ["“ö–æ—Å –ë—É—Ä–≥–µ—Ä", "–ö–∞—Ä—Ç–æ–ø –§—Ä–∏ “Ø–ª–∫–µ–Ω", "–°“Ø—Ç—Ç—ñ –∫–æ–∫—Ç–µ–π–ª—å"], "price": 3200, "saving": 800},
    {"name": "–ö–û–ú–ë–û #3 –ü–∏—Ü—Ü–∞ –ü–∞—Ç–∏", "items": ["–ü–µ–ø–ø–µ—Ä–æ–Ω–∏ (30—Å–º)", "2x –ö–æ–ª–∞ 0.5–ª", "–Ü—Ä—ñ–º—à—ñ–∫ —Ç–∞—è“õ—à–∞–ª–∞—Ä"], "price": 3600, "saving": 750},
    {"name": "–û–¢–ë–ê–°–´–õ–´“ö –ñ–ò–´–ù", "items": ["2x “ö–æ—Å –ë—É—Ä–≥–µ—Ä", "–ü–µ–ø–ø–µ—Ä–æ–Ω–∏ (30—Å–º)", "–ö–∞—Ä—Ç–æ–ø –§—Ä–∏ “Ø–ª–∫–µ–Ω", "4x —Å—É—Å—ã–Ω"], "price": 8000, "saving": 1800}
]

PROMOS = """üî• “ö–ê–ó–Ü–†–ì–Ü –ê–ö–¶–ò–Ø–õ–ê–†:
‚Ä¢ –ö“Ø–Ω —Å–∞–π—ã–Ω 11:00-14:00: –±–∞—Ä–ª—ã“õ –∫–æ–º–±–æ“ì–∞ -20%
‚Ä¢ ”ò—Ä —Å”ô—Ä—Å–µ–Ω–±—ñ: –µ–∫—ñ–Ω—à—ñ –ø–∏—Ü—Ü–∞“ì–∞ -50%
‚Ä¢ –ñ“±–º–∞-–ñ–µ–∫—Å–µ–Ω–±—ñ: 4500‚Ç∏ –∂–æ“ì–∞—Ä—ã —Ç–∞–ø—Å—ã—Ä—ã—Å“õ–∞ –¥–µ—Å–µ—Ä—Ç —Å—ã–π–ª—ã“õ
‚Ä¢ ”®–∑—ñ“£—ñ–∑ –∞–ª—ã–ø –∫–µ—Ç—Å–µ“£—ñ–∑: –±–∞—Ä–ª—ã“õ —Ç–∞–ø—Å—ã—Ä—ã—Å“õ–∞ -10%
‚Ä¢ –ê–ª“ì–∞—à“õ—ã —Ç–∞–ø—Å—ã—Ä—ã—Å: -15% –ø—Ä–æ–º–æ–∫–æ–¥ FIRST15"""

INFO = """üìç –†–ï–°–¢–û–†–ê–ù –¢–£–†–ê–õ–´:
‚Ä¢ –ú–µ–∫–µ–Ω-–∂–∞–π—ã: ”ò–±–∞–π –∫”©—à–µ—Å—ñ, 123, –¢“Ø—Ä–∫—ñ—Å—Ç–∞–Ω
‚Ä¢ –ñ“±–º—ã—Å —É–∞“õ—ã—Ç—ã: 10:00 - 00:00 (–∫“Ø–Ω–¥–µ–ª—ñ–∫—Ç—ñ)
‚Ä¢ –ñ–µ—Ç–∫—ñ–∑—É: 11:00 - 23:00
‚Ä¢ –ú–∏–Ω–∏–º–∞–ª–¥—ã —Ç–∞–ø—Å—ã—Ä—ã—Å: 1800‚Ç∏
‚Ä¢ –ñ–µ—Ç–∫—ñ–∑—É “õ“±–Ω—ã: 900‚Ç∏ (6500‚Ç∏ –∂–æ“ì–∞—Ä—ã —Ç–µ–≥—ñ–Ω)
‚Ä¢ –û—Ä—Ç–∞—à–∞ –∂–µ—Ç–∫—ñ–∑—É —É–∞“õ—ã—Ç—ã: 35-45 –º–∏–Ω—É—Ç
‚Ä¢ –¢”©–ª–µ–º: “õ–æ–ª–º–∞-“õ–æ–ª –∫—É—Ä—å–µ—Ä–≥–µ, Kaspi, –∫–∞—Ä—Ç–∞–ª–∞—Ä"""

# ======================== AI –°–ò–°–¢–ï–ú–ê ========================
SYSTEM_PROMPT = f"""–°–µ–Ω "Turan Fast food" —Ñ–∞—Å—Ç—Ñ—É–¥ –º–µ–π—Ä–∞–º—Ö–∞–Ω–∞—Å—ã–Ω—ã“£ –∫”ô—Å—ñ–±–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—ñ AIdos.
–°–µ–Ω –∫–ª–∏–µ–Ω—Ç—Ç—ñ“£ —Ç—ñ–ª—ñ–Ω–¥–µ (“ö–ê–ó–ê“ö–®–ê –Ω–µ–º–µ—Å–µ –û–†–´–°–®–ê) —Å”©–π–ª–µ—Å–µ—Å—ñ“£. –ö–ª–∏–µ–Ω—Ç “õ–∞–π —Ç—ñ–ª–¥–µ –∂–∞–∑—Å–∞, —Å–æ–ª —Ç—ñ–ª–¥–µ –∂–∞—É–∞–ø –±–µ—Ä.

–ë–ê–°–¢–´ –ú–ê“ö–°–ê–¢–´“¢: ”ò—Ä–±—ñ—Ä –∫–ª–∏–µ–Ω—Ç—Ç—ñ —Ç–∞–ø—Å—ã—Ä—ã—Å“õ–∞ –¥–µ–π—ñ–Ω –∂–µ—Ç–∫—ñ–∑—É - 99% —Å–∞—Ç—ã–ª—ã–º.

–°–ê–¢–£ –°–ö–†–ò–ü–¢–Ü (–ö–ª–∏–µ–Ω—Ç —Ç—ñ–ª—ñ–Ω–µ –∞—É–¥–∞—Ä—ã–ø “õ–æ–ª–¥–∞–Ω):

1Ô∏è‚É£ –°”ò–õ–ï–ú–î–ï–°–£:
   - –°”ô–ª–µ–º –¥–µ, —Å–º–∞–π–ª–∏–∫—Ç—ñ —Å–∏—Ä–µ–∫ “õ–æ–ª–¥–∞–Ω
   - ”®–∑—ñ“£–¥—ñ —Ç–∞–Ω—ã—Å—Ç—ã—Ä: "–ú–µ–Ω AIdos, –º–µ–Ω–µ–¥–∂–µ—Ä–º—ñ—ñ–Ω"
   - –°“±—Ä–∞: "“ö–∞–ª–∞–π –∫”©–º–µ–∫—Ç–µ—Å–µ –∞–ª–∞–º—ã–Ω?"
   - “ö–∞—Ä–∞–ø–∞–π—ã–º —Å”©–π–ª–µ—Å: "–∏”ô", "—Ç“Ø—Å—ñ–Ω—ñ–∫—Ç—ñ", "–∂–∞“õ—Å—ã"

2Ô∏è‚É£ “ö–ê–ñ–ï–¢–¢–Ü–õ–Ü–ö –ê–ù–´“ö–¢–ê–£:
   - –ï–≥–µ—Ä –∫–ª–∏–µ–Ω—Ç –±—ñ–ª–º–µ—Å–µ –Ω–µ —Ç–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä–µ—Ç—ñ–Ω—ñ–Ω - –º”ô–∑—ñ—Ä —Å—É—Ä–µ—Ç—ñ–Ω “±—Å—ã–Ω!
   - –°“±—Ä–∞: "–ù–µ—à–µ –∞–¥–∞–º“ì–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å?" 
   - –°“±—Ä–∞: "–ï—Ç—Ç—ñ “±–Ω–∞—Ç–∞—Å—ã–∑ –±–∞, ”ô–ª–¥–µ —Ç–∞—É—ã“õ—Ç—ã?"
   - –°“±—Ä–∞: "–°—É—Å—ã–Ω –∫–µ—Ä–µ–∫ –ø–µ?"

3Ô∏è‚É£ –ü–†–ï–ó–ï–ù–¢–ê–¶–ò–Ø:
   - –ö–û–ú–ë–û-–Ω—ã –±—ñ—Ä—ñ–Ω—à—ñ “±—Å—ã–Ω (“Ø–Ω–µ–º–¥–µ—É–¥—ñ –∫”©—Ä—Å–µ—Ç!)
   - –¢–∞“ì–∞–º–¥—ã –¥”ô–º–¥—ñ —Å–∏–ø–∞—Ç—Ç–∞
   - –ê–∫—Ü–∏—è–ª–∞—Ä–¥—ã –∞–π—Ç
   - –ê–π—Ç: "–ë—ñ–∑–¥—ñ“£ —Ö–∏—Ç!", "“ö–æ–Ω–∞“õ—Ç–∞—Ä –∂–∞“õ—Å—ã –∫”©—Ä–µ–¥—ñ!"

4Ô∏è‚É£ “ö–û–°–´–ú–®–ê –°–ê–¢–£:
   - –°—É—Å—ã–Ω –∞–ª–º–∞—Å–∞ “±—Å—ã–Ω
   - –î–µ—Å–µ—Ä—Ç “±—Å—ã–Ω
   - "–ú“Ø–º–∫—ñ–Ω “õ–æ—Å–∞–º—ã–∑ –±–∞..."

5Ô∏è‚É£ “ö–ê–†–°–´–õ–´“ö–ü–ï–ù –ñ“∞–ú–´–°:
   - "“ö—ã–º–±–∞—Ç" ‚Üí –ö–æ–º–±–æ –∫”©—Ä—Å–µ—Ç, –∞–∫—Ü–∏—è –∞–π—Ç
   - "–û–π–ª–∞–Ω–∞–º—ã–Ω" ‚Üí "–ê–∫—Ü–∏—è –±“Ø–≥—ñ–Ω “ì–∞–Ω–∞!"
   - "–ê—à –µ–º–µ—Å–ø—ñ–Ω" ‚Üí "–ö–µ–π—ñ–Ω–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—ñ“£—ñ–∑"

6Ô∏è‚É£ –¢”®–õ–ï–ú ”ò–î–Ü–°–Ü–ù –°“∞–†–ê–£ (–ú–Ü–ù–î–ï–¢–¢–Ü!):
   - –°“±—Ä–∞: "–¢”©–ª–µ–º–¥—ñ “õ–∞–ª–∞–π –∂–∞—Å–∞–π—Å—ã–∑?"
   - –û–ø—Ü–∏—è–ª–∞—Ä: 
     –∞) "“ö–æ–ª–º–∞-“õ–æ–ª –∫—É—Ä—å–µ—Ä–≥–µ" - –¥–∞–π—ã–Ω, —Ä–∞—Å—Ç–∞—É –∫–µ—Ä–µ–∫ –µ–º–µ—Å
     –±) "Kaspi –∫”©—à—ñ—Ä—É" - —á–µ–∫ –∫–µ—Ä–µ–∫, –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å—Ç–∞–π–¥—ã
     –≤) "–ö–∞—Ä—Ç–∞–º–µ–Ω –∫—É—Ä—å–µ—Ä–≥–µ" - –¥–∞–π—ã–Ω

7Ô∏è‚É£ –ï–ì–ï–† “ö–û–õ–ú–ê-“ö–û–õ –ö–£–†–¨–ï–†–ì–ï:
   - –ê–π—Ç: "–ñ–∞“õ—Å—ã! –î”ô–ª –∞“õ—à–∞“£—ã–∑–¥—ã –¥–∞–π—ã–Ω–¥–∞–ø “õ–æ–π—ã“£—ã–∑"
   - –ê–π—Ç: "–ö—É—Ä—å–µ—Ä –∫–µ–ª–≥–µ–Ω–¥–µ —Ç”©–ª–µ–π—Å—ñ–∑"
   - –ú–µ–∫–µ–Ω-–∂–∞–π –∞–ª
   - –†–∞—Å—Ç–∞—É –±–µ—Ä
   - –£–∞“õ—ã—Ç—Ç—ã –∞–π—Ç: "35-45 –º–∏–Ω—É—Ç—Ç–∞ –∂–µ—Ç–∫—ñ–∑–µ–º—ñ–∑"
   - KASPI –†–ï–ö–í–ò–ó–ò–¢ –ñ–Ü–ë–ï–†–ú–ï–ô–î–Ü!

8Ô∏è‚É£ –ï–ì–ï–† KASPI –ö”®–®–Ü–†–£:
   - –ú–µ–∫–µ–Ω-–∂–∞–π –∞–ª
   - –†–∞—Å—Ç–∞—É –±–µ—Ä
   - Kaspi —Ä–µ–∫–≤–∏–∑–∏—Ç—ñ–Ω –∂—ñ–±–µ—Ä:
     "–¢”©–ª–µ–º “Ø—à—ñ–Ω Kaspi-–≥–µ –∫”©—à—ñ—Ä—ñ“£—ñ–∑:
     üì± {KASPI_NUMBER}
     üë§ {KASPI_NAME}
     üí∞ –°–æ–º–∞: [–°–£–ú–ú–ê]‚Ç∏
     
     –ö”©—à—ñ—Ä–≥–µ–Ω–Ω–µ–Ω –∫–µ–π—ñ–Ω —á–µ–∫—Ç—ñ PDF —Ñ–æ—Ä–º–∞—Ç—ã–Ω–¥–∞ –∂—ñ–±–µ—Ä—ñ“£—ñ–∑ üìÑ
     –ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å—Ç–∞“ì–∞–Ω–Ω–∞–Ω –∫–µ–π—ñ–Ω –¥–∞–π—ã–Ω–¥–∞—É“ì–∞ –∫—ñ—Ä—ñ—Å–µ–º—ñ–∑!"

9Ô∏è‚É£ –ß–ï–ö –ö“Æ–¢–£ (—Ç–µ–∫ Kaspi “Ø—à—ñ–Ω):
   - "–ß–µ–∫—Ç—ñ –∂—ñ–±–µ—Ä–≥–µ–Ω–Ω–µ–Ω –∫–µ–π—ñ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä 2-3 –º–∏–Ω—É—Ç—Ç–∞ —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ"
   - "–†–∞—Å—Ç–∞“ì–∞–Ω–Ω–∞–Ω –∫–µ–π—ñ–Ω –¥–∞–π—ã–Ω–¥–∞—É“ì–∞ –∫—ñ—Ä—ñ—Å–µ–º—ñ–∑"

üîü –ú”ò–ó–Ü–† –°–£–†–ï–¢:
   - –ï–≥–µ—Ä –∫–ª–∏–µ–Ω—Ç —Å“±—Ä–∞—Å–∞ "–º”ô–∑—ñ—Ä", "–Ω–µ –±–∞—Ä", "–∫”©—Ä—Å–µ—Ç", "–±—ñ–ª–º–µ–π–º—ñ–Ω –Ω–µ —Ç–∞–ø—Å—ã—Ä—ã—Å–∞–º—ã–Ω"
   - –ê–π—Ç: "–ú”ô–∑—ñ—Ä—ñ–º—ñ–∑–¥—ñ –∂—ñ–±–µ—Ä–¥—ñ–º! –ö”©—Ä—ñ“£—ñ–∑ üëá"
   - (–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ —Å—É—Ä–µ—Ç—Ç—ñ –∂—ñ–±–µ—Ä–µ–¥—ñ)

–ú”ò–ó–Ü–†:
{json.dumps(MENU, ensure_ascii=False, indent=2)}

–ö–û–ú–ë–û:
{json.dumps(COMBOS, ensure_ascii=False, indent=2)}

{PROMOS}
{INFO}

“ö–ê–ó–ê“ö–®–ê –ì–†–ê–ú–ú–ê–¢–ò–ö–ê:
‚úÖ –î“±—Ä—ã—Å: "–∫”©—à–µ—Å—ñ" (–µ–º–µ—Å "–∫-—Å—ñ")
‚úÖ –î“±—Ä—ã—Å: "–∂–æ“ì–∞—Ä—ã" (–µ–º–µ—Å "–¥–µ–Ω –∂–æ“ì–∞—Ä—ã" - –∞—Ä—Ç—ã“õ)
‚úÖ –î“±—Ä—ã—Å: "–º–µ–Ω–µ–¥–∂–µ—Ä–º—ñ—ñ–Ω" (–µ–º–µ—Å "–º–µ–Ω–µ–¥–∂–µ—Ä—ñ")
‚úÖ –î“±—Ä—ã—Å: "–°”ô–ª–µ–º! –ú–µ–Ω AIdos, –º–µ–Ω–µ–¥–∂–µ—Ä–º—ñ—ñ–Ω" (—Ç–∞–±–∏“ì–∏)
‚úÖ –î“±—Ä—ã—Å: "“ö–∞–ª–∞–π –∫”©–º–µ–∫—Ç–µ—Å–µ –∞–ª–∞–º—ã–Ω?" (–µ–º–µ—Å "–∞–ª–∞—Ç—ã–Ω–¥—ã")
‚úÖ –°–º–∞–π–ª–∏–∫—Ç—ñ –∞–∑ “õ–æ–ª–¥–∞–Ω

–ï–†–ï–ñ–ï–õ–ï–†:
‚úÖ “ö—ã—Å“õ–∞ —Ö–∞–±–∞—Ä–ª–∞–º–∞ (2-4 —Å”©–π–ª–µ–º)
‚úÖ –¢”©–ª–µ–º ”ô–¥—ñ—Å—ñ–Ω –ú–Ü–ù–î–ï–¢–¢–Ü —Å“±—Ä–∞
‚úÖ “ö–æ–ª–º–∞-“õ–æ–ª –±–æ–ª—Å–∞ - Kaspi –∂—ñ–±–µ—Ä–º–µ–π–¥—ñ
‚úÖ –ú”ô–∑—ñ—Ä —Å“±—Ä–∞—Å–∞ - —Å—É—Ä–µ—Ç—Ç—ñ “±—Å—ã–Ω
‚úÖ 99% —Å–∞—Ç—ã–ª—ã–º!
"""

client = OpenAI(api_key=PERPLEXITY_API_KEY, base_url="https://api.perplexity.ai")

conversations = {}
processed_message_ids = set()
processed_lock = threading.Lock()

def ensure_conversation(user_phone):
    if user_phone not in conversations:
        conversations[user_phone] = {
            "messages": [],
            "stage": "greeting",
            "payment_method": None,
            "order_details": {}
        }
    return conversations[user_phone]

def remember_user_message_only(user_phone, user_message):
    conv = ensure_conversation(user_phone)
    conv["messages"].append({"role": "user", "content": user_message})
    if len(conv["messages"]) > 20:
        conv["messages"] = conv["messages"][-20:]
    return conv

def mark_message_processed(msg_id):
    if not msg_id:
        return False
    with processed_lock:
        if msg_id in processed_message_ids:
            return False
        processed_message_ids.add(msg_id)
        if len(processed_message_ids) > 2000:
            processed_message_ids.clear()
    return True

def should_send_menu(text):
    text_lower = text.lower()
    if any(word in text_lower for word in MENU_KEYWORDS):
        return True
    # "–Ω–µ –∑–Ω–∞—é" + "—á—Ç–æ" + "–∑–∞–∫–∞–∑–∞—Ç—å" —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã–µ –ø–æ —Ñ—Ä–∞–∑–µ
    if "–Ω–µ" in text_lower and "–∑–Ω–∞" in text_lower and "–∑–∞–∫–∞–∑" in text_lower:
        return True
    return False

def send_menu(user_phone):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω—é –∫–ª–∏–µ–Ω—Ç—É"""
    if os.path.exists(MENU_IMAGE_PATH):
        sent = send_image(user_phone, MENU_IMAGE_PATH, "üìã")
        if sent:
            print(f"‚úÖ –ú–µ–Ω—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {user_phone}")
            return True
        else:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–Ω—é {user_phone}")
            return False
    return False

def handle_incoming_message(user_phone, user_message):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    print(f"üì© –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_phone}: {user_message}")
    
    menu_sent = None
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω—é
    if should_send_menu(user_message):
        menu_sent = send_menu(user_phone)
        # –ù–µ –¥–µ–ª–∞–µ–º return, —á—Ç–æ–±—ã AI —Ç–æ–∂–µ –æ—Ç–≤–µ—Ç–∏–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä "–í–æ—Ç –Ω–∞—à–µ –º–µ–Ω—é, —á—Ç–æ –≤—ã–±–µ—Ä–µ—Ç–µ?")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
    send_typing(user_phone)
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI
    ai_response = get_ai_response(user_phone, user_message, menu_sent_status=menu_sent)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
    send_message(user_phone, ai_response)
    print(f"‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω {user_phone}")

# ======================== WHATSAPP ========================
def send_message(to, text):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç"""
    url = "https://gate.whapi.cloud/messages/text"
    headers = {"accept": "application/json", "content-type": "application/json"}
    params = {"token": WHATSAPP_TOKEN}
    data = {"to": to, "body": text}
    
    try:
        r = requests.post(url, params=params, headers=headers, json=data, timeout=10)
        return r.status_code in [200, 201]
    except Exception as e:
        print(f"[ERROR] send_message: {e}")
        return False

def send_image(to, image_path, caption=""):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"""
    url = "https://gate.whapi.cloud/messages/image"
    headers = {"accept": "application/json"}
    params = {"token": WHATSAPP_TOKEN}
    
    try:
        with open(image_path, 'rb') as f:
            files = {"media": f}
            data = {"to": to, "caption": caption}
            r = requests.post(url, params=params, headers=headers, data=data, files=files, timeout=30)
            if r.status_code not in [200, 201]:
                print(f"[ERROR] send_image failed: {r.status_code} - {r.text}")
            return r.status_code in [200, 201]
    except Exception as e:
        print(f"[ERROR] send_image: {e}")
        return False

def send_typing(to):
    """–ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞"""
    url = "https://gate.whapi.cloud/messages/typing"
    headers = {"accept": "application/json", "content-type": "application/json"}
    params = {"token": WHATSAPP_TOKEN}
    data = {"to": to, "duration": 2}
    
    try:
        requests.post(url, params=params, headers=headers, json=data, timeout=5)
    except:
        pass

# ======================== AI ========================
def get_ai_response(user_phone, user_message, menu_sent_status=None):
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç AI"""
    conv = remember_user_message_only(user_phone, user_message)
    
    messages = [{"role": "system", "content": SYSTEM_PROMPT}] + conv["messages"]
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–Ω—é
    if menu_sent_status is True:
        messages.append({"role": "system", "content": "SYSTEM: –ú”ô–∑—ñ—Ä —Å—É—Ä–µ—Ç—ñ –∫–ª–∏–µ–Ω—Ç–∫–µ —Å”ô—Ç—Ç—ñ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ. –ö–ª–∏–µ–Ω—Ç–∫–µ –º”ô–∑—ñ—Ä–¥—ñ “õ–∞—Ä–∞—É–¥—ã “±—Å—ã–Ω."})
    elif menu_sent_status is False:
        messages.append({"role": "system", "content": "SYSTEM: –ú”ô–∑—ñ—Ä —Å—É—Ä–µ—Ç—ñ–Ω –∂—ñ–±–µ—Ä—É –∫–µ–∑—ñ–Ω–¥–µ “ö–ê–¢–ï —à—ã“õ—Ç—ã (—Ç–µ—Ö–Ω–∏–∫–∞–ª—ã“õ –∞“õ–∞—É). –ö–ª–∏–µ–Ω—Ç—Ç–µ–Ω –∫–µ—à—ñ—Ä—ñ–º —Å“±—Ä–∞ –∂”ô–Ω–µ –º”ô–∑—ñ—Ä–¥—ñ –º”ô—Ç—ñ–Ω —Ç“Ø—Ä—ñ–Ω–¥–µ –∂–∞–∑—ã–ø –±–µ—Ä."})
    
    try:
        response = client.chat.completions.create(
            model="sonar-pro",
            messages=messages,
            temperature=0.7,
            max_tokens=600,
            extra_body={"disable_search": True}
        )
        
        ai_reply = response.choices[0].message.content
        conv["messages"].append({"role": "assistant", "content": ai_reply})
        
        if len(conv["messages"]) > 20:
            conv["messages"] = conv["messages"][-20:]
        
        return ai_reply
    except Exception as e:
        print(f"[ERROR] AI: {e}")
        return "–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, —Ç–µ—Ö–Ω–∏–∫–∞–ª—ã“õ –∞“õ–∞—É. “ö–∞–π—Ç–∞–ª–∞“£—ã–∑!"

# ======================== POLLING ========================
def poll_messages():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Polling"""
    url = "https://gate.whapi.cloud/messages/list"
    headers = {"accept": "application/json"}
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ, –∏–ª–∏ –Ω–æ–≤—ã–µ
    # –ù–æ –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ –±—Ä–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20-50 –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ ID
    params = {
        "token": WHATSAPP_TOKEN,
        "count": 20,
        "time_from": LAUNCH_TIMESTAMP  # –¢–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏—à–µ–¥—à–∏–µ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
    }
    
    try:
        r = requests.get(url, params=params, headers=headers, timeout=10)
        if r.status_code == 200:
            data = r.json()
            messages = data.get("messages", [])
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ –ø–æ—Ä—è–¥–∫—É
            # Whapi –æ–±—ã—á–Ω–æ –æ—Ç–¥–∞–µ—Ç –æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º, –ø–æ—ç—Ç–æ–º—É reverse
            for msg in reversed(messages):
                msg_id = msg.get("id")
                
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
                if not mark_message_processed(msg_id):
                    continue
                
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if msg.get("from_me", False):
                    continue
                
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                msg_type = msg.get("type", "")
                user_phone = msg.get("chat_id", "")

                # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã
                if user_phone.endswith("@g.us"):
                    continue
                
                if msg_type == "text":
                    user_message = msg.get("text", {}).get("body", "")
                    if user_message and user_phone:
                        handle_incoming_message(user_phone, user_message)
                else:
                    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ (—Ñ–æ—Ç–æ, –∞—É–¥–∏–æ) –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    pass
                    
        else:
            print(f"‚ö†Ô∏è Polling error: {r.status_code} - {r.text}")
            
    except Exception as e:
        print(f"[ERROR] Polling: {e}")

# ======================== –ó–ê–ü–£–°–ö ========================
if __name__ == "__main__":
    print("=" * 70)
    print("üçî AI –ú–ï–ù–ï–î–ñ–ï–† –§–ê–°–¢-–§–£–î–ê (POLLING MODE) üçî")
    print("=" * 70)
    print(f"‚è∞ –ó–∞–ø—É—â–µ–Ω: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"üì∑ –ú–µ–Ω—é —Ñ–æ—Ç–æ: {MENU_IMAGE_PATH}")
    print(f"üìû –¢–µ–ª–µ—Ñ–æ–Ω WhatsApp: {WHATSAPP_PHONE_ID or '‚õîÔ∏è –Ω–µ —É–∫–∞–∑–∞–Ω'}")
    print("=" * 70)
    print("\nüöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ —Ä–µ–∂–∏–º–µ POLLING (–æ–ø—Ä–æ—Å —Å–µ—Ä–≤–µ—Ä–∞)...")
    print("   –ù–∞–∂–º–∏—Ç–µ CTRL+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏\n")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–µ–Ω—é —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if os.path.exists(MENU_IMAGE_PATH):
        print(f"‚úÖ –§–æ—Ç–æ –º–µ–Ω—é –Ω–∞–π–¥–µ–Ω–æ: {MENU_IMAGE_PATH}")
    else:
        print(f"‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –§–æ—Ç–æ –º–µ–Ω—é –ù–ï –Ω–∞–π–¥–µ–Ω–æ: {MENU_IMAGE_PATH}")
        print(f"   –ü–æ–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª menu.jpg —Ä—è–¥–æ–º —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º!")
    
    print("\n" + "="*70 + "\n")
    
    while True:
        try:
            poll_messages()
            time.sleep(3) # –ü–∞—É–∑–∞ 3 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –æ–ø—Ä–æ—Å–∞–º–∏
        except KeyboardInterrupt:
            print("\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
            break
        except Exception as e:
            print(f"\n‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ: {e}")
            time.sleep(5)